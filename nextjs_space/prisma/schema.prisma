generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/impactusall_mvp/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// NEXTAUTH TABLES (Required for NextAuth.js)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// APPLICATION TABLES
// ============================================

enum UserRole {
  PUBLIC_USER
  CHARITY_ADMIN
  CORPORATE_DONOR
  PLATFORM_ADMIN
}

enum CorporateRole {
  ADMIN
  VIEWER
}

enum FileType {
  IMAGE
  VIDEO
}

enum StoryStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model User {
  id                 String          @id @default(cuid())
  email              String          @unique
  emailVerified      DateTime?
  password           String          // bcrypt hashed password
  name               String
  role               UserRole        @default(PUBLIC_USER)
  corporateRole      CorporateRole?  // For CORPORATE_DONOR users: Admin or Viewer
  image              String?
  
  // Email verification
  verificationToken  String?   @unique
  
  // Password reset
  resetToken         String?   @unique
  resetTokenExpires  DateTime?
  
  // Relationships
  charityId          String?
  donorId            String?
  charity            Charity?  @relation(fields: [charityId], references: [id])
  donor              Donor?    @relation(fields: [donorId], references: [id])
  
  // Timestamps
  createdAt          DateTime  @default(now())
  lastLogin          DateTime?
  updatedAt          DateTime  @updatedAt
  
  // NextAuth relations
  accounts           Account[]
  sessions           Session[]
  
  // Application relations
  storiesCreated     Story[]    @relation("StoryCreator")
  storiesUpdated     Story[]    @relation("StoryUpdater")
  likes              Like[]
  reactions          Reaction[]
  comments           Comment[]  @relation("CommentAuthor")
  moderatedComments  Comment[]  @relation("CommentModerator")

  @@index([email])
  @@index([charityId])
  @@index([donorId])
  @@index([verificationToken])
  @@index([resetToken])
}

enum CharityStatus {
  PENDING
  APPROVED
  REJECTED
}

model Charity {
  id                  String         @id @default(cuid())
  name                String
  description         String?        @db.Text
  logoUrl             String?
  websiteUrl          String?
  location            String?        // UK city/region
  focusArea           String?        // e.g., homelessness, food banks, youth services
  registrationNumber  String?        // UK charity registration number
  status              CharityStatus  @default(PENDING)
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  // Relations
  users               User[]
  stories             Story[]
  donors              Donor[]

  @@index([name])
  @@index([status])
}

model Donor {
  id                  String   @id @default(cuid())
  name                String
  slug                String   @unique  // For URLs (e.g., "manchester-united", "techcorp-uk")
  logoUrl             String?
  donationAmount      Decimal? @db.Decimal(10, 2)
  
  // Branding for donor-specific hubs
  primaryColor        String?  @default("#ea580c")  // Orange default
  secondaryColor      String?  @default("#14b8a6")  // Teal default
  tagline             String?  @db.Text  // e.g., "Manchester United's Impact Stories"
  websiteUrl          String?
  
  // Email notification preferences (JSON)
  emailPreferences    Json?    @default("{\"newStories\": true, \"weeklyDigest\": false, \"monthlyReports\": false}")
  
  // Optional charity relationship
  charityId           String?
  charity             Charity? @relation(fields: [charityId], references: [id])
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  users               User[]
  stories             Story[]
  analytics           Analytics[]

  @@index([slug])
  @@index([charityId])
}

model Story {
  id                  String       @id @default(cuid())
  charityId           String
  donorId             String?
  
  // Content
  title               String
  slug                String       // For URLs
  content             String       @db.Text  // Rich text HTML
  excerpt             String?      @db.Text  // Short summary
  featuredImageUrl    String?
  
  // Impact Metrics (stored as JSON)
  impactMetrics       Json?        // {families_helped: 25, hours_of_care: 150, etc.}
  
  // Status
  status              StoryStatus  @default(DRAFT)
  publishedAt         DateTime?
  
  // Metadata
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  createdById         String
  updatedById         String?
  
  // Relations
  charity             Charity      @relation(fields: [charityId], references: [id])
  donor               Donor?       @relation(fields: [donorId], references: [id])
  createdBy           User         @relation("StoryCreator", fields: [createdById], references: [id])
  updatedBy           User?        @relation("StoryUpdater", fields: [updatedById], references: [id])
  
  media               Media[]
  likes               Like[]
  reactions           Reaction[]
  comments            Comment[]
  milestones          StoryMilestone[]
  thankYouMessages    ThankYouMessage[]
  analytics           Analytics[]

  @@unique([slug, charityId])
  @@index([charityId])
  @@index([donorId])
  @@index([status])
  @@index([publishedAt])
}

model Media {
  id                  String     @id @default(cuid())
  storyId             String
  
  // File Info
  fileUrl             String     // CDN URL
  fileType            FileType
  fileSize            Int?       // in bytes
  fileName            String?    // Original filename
  
  // Metadata
  altText             String?
  caption             String?    @db.Text
  displayOrder        Int        @default(0)
  
  uploadedAt          DateTime   @default(now())
  
  // Relations
  story               Story      @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
}

model Like {
  id                  String     @id @default(cuid())
  storyId             String
  
  // User Info (nullable for anonymous likes)
  userId              String?
  ipAddress           String?    // For anonymous users
  
  createdAt           DateTime   @default(now())
  
  // Relations
  story               Story      @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user                User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
  @@unique([storyId, ipAddress])
  @@index([storyId])
  @@index([userId])
}

model Analytics {
  id                  String     @id @default(cuid())
  storyId             String
  donorId             String?
  date                DateTime   @db.Date
  
  // Engagement Metrics
  views               Int        @default(0)
  uniqueVisitors      Int        @default(0)
  likes               Int        @default(0)
  shares              Int        @default(0)
  comments            Int        @default(0)
  reactions           Int        @default(0)
  
  // Social Media Breakdown
  sharesTwitter       Int        @default(0)
  sharesFacebook      Int        @default(0)
  sharesLinkedin      Int        @default(0)
  sharesInstagram     Int        @default(0)
  sharesWhatsapp      Int        @default(0)
  
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  
  // Relations
  story               Story      @relation(fields: [storyId], references: [id], onDelete: Cascade)
  donor               Donor?     @relation(fields: [donorId], references: [id])

  @@unique([storyId, date])
  @@index([storyId])
  @@index([donorId])
  @@index([date])
}

enum ReactionType {
  LOVE
  APPLAUSE
  MOVED
  INSPIRED
  GRATEFUL
}

model Reaction {
  id                  String       @id @default(cuid())
  storyId             String
  
  // User Info (nullable for anonymous reactions)
  userId              String?
  ipAddress           String?      // For anonymous users
  
  // Reaction Type
  reactionType        ReactionType
  
  createdAt           DateTime     @default(now())
  
  // Relations
  story               Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user                User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId, reactionType])
  @@unique([storyId, ipAddress, reactionType])
  @@index([storyId])
  @@index([userId])
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
}

model Comment {
  id                  String        @id @default(cuid())
  storyId             String
  
  // User Info
  userId              String?
  userName            String        // Display name (for anonymous comments)
  userEmail           String?       // Optional, for moderation contact
  
  // Content
  content             String        @db.Text
  
  // Moderation
  status              CommentStatus @default(PENDING)
  moderatedAt         DateTime?
  moderatedById       String?
  moderatedBy         User?         @relation("CommentModerator", fields: [moderatedById], references: [id])
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  // Relations
  story               Story         @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user                User?         @relation("CommentAuthor", fields: [userId], references: [id], onDelete: SetNull)

  @@index([storyId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model StoryMilestone {
  id                  String       @id @default(cuid())
  storyId             String
  
  // Milestone Info
  title               String
  description         String       @db.Text
  date                DateTime
  displayOrder        Int          @default(0)
  
  // Optional Media
  imageUrl            String?
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  // Relations
  story               Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@index([date])
}

model ThankYouMessage {
  id                  String       @id @default(cuid())
  storyId             String
  
  // Message Info
  authorName          String       // Name of person giving thanks (e.g., "Emma's Family")
  message             String       @db.Text
  
  // Optional Media
  authorPhotoUrl      String?
  
  // Display
  featured            Boolean      @default(false)  // Show prominently on story page
  displayOrder        Int          @default(0)
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  // Relations
  story               Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@index([featured])
}
